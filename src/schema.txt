CREATE SCHEMA IF NOT EXISTS sagrow_admin;

CREATE TABLE sagrow_admin.users (
    id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    email_id character varying(100) NOT NULL,
    password_hash text NOT NULL,
    full_name character varying(100),
    mobile_no character varying(10),
    role character(1) DEFAULT 'U'::character varying NOT NULL,
    is_locked boolean DEFAULT false NOT NULL,
    created_by character varying(100) NOT NULL,
    created_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    reset_password_token character varying(255),
    reset_password_expires timestamp with time zone,
    login_failed integer,
    state character(1),
    CONSTRAINT users_pkey PRIMARY KEY (id),
    CONSTRAINT users_email_id_key UNIQUE (email_id)
);
INSERT INTO sagrow_admin.users (
    email_id,
    password_hash,
    full_name,
    mobile_no,
    role,
    state,
    created_by
)
VALUES (
    'admin@sagrow.com',
    '$2a$10$KpKzR9zZ9kQXJ5nCq8YkN.xxxxxxxxxxxxxxx',
    'System Admin',
    '9999999999',
    'A', -- Admin
    'T', -- Tamil Nadu
    'SYSTEM'
)
ON CONFLICT (email_id) DO NOTHING;

CREATE TABLE sagrow_admin.students (
    id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    name character varying(100),
    mobile_no character varying(10),
    email_id character varying(50),
    experience_level character(1),
    years_of_experience character(1),
    state character(1),
    created_time timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    created_by character varying(50),
    CONSTRAINT students_pkey PRIMARY KEY (id),
    CONSTRAINT unique_students_email UNIQUE (email_id),
    CONSTRAINT unique_students_mobile UNIQUE (mobile_no)
);

CREATE TABLE sagrow_admin.login (
    id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    user_id bigint NOT NULL,
    email_id character varying(100) NOT NULL,
    access_token_hash text NOT NULL,
    refresh_token_hash text NOT NULL,
    ip_address character varying(50),
    user_agent text,
    is_active boolean DEFAULT true,
    login_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    expires_at timestamp without time zone NOT NULL,
    created_by character varying(100),
    CONSTRAINT login_pkey PRIMARY KEY (id),
    CONSTRAINT fk_user_logins_user FOREIGN KEY (user_id) REFERENCES sagrow_admin.users(id) ON DELETE CASCADE
);

CREATE TABLE sagrow_admin.logout (
    id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    user_login_id bigint NOT NULL,
    logout_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    ip_address character varying(50),
    CONSTRAINT logout_pkey PRIMARY KEY (id),
    CONSTRAINT fk_user_logouts_login FOREIGN KEY (user_login_id) REFERENCES sagrow_admin.login(id) ON DELETE CASCADE
);

CREATE TABLE sagrow_admin.excel_history (
    id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    excel_size bigint NOT NULL,
    student_count bigint NOT NULL,
    download_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP NOT NULL,
    download_by character varying(50) NOT NULL,
    CONSTRAINT excel_history_pkey PRIMARY KEY (id)
);